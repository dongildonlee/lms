{% extends "base.html" %}
{% block title %}Statistics | Wrong-Answer Packets{% endblock %}

{% block content %}
<h1 class="text-3xl font-semibold mb-6 text-white drop-shadow">Your Statistics</h1>

<div class="grid gap-6 md:grid-cols-2">
  <!-- Accuracy card -->
  <div class="bg-white rounded-2xl p-6 shadow border border-gray-200">
    <h2 class="text-xl font-semibold mb-1 text-slate-900">Accuracy</h2>
    <p class="text-slate-600 mb-4">(# correct of all questions you viewed)</p>

    <div class="w-full h-8 rounded-lg overflow-hidden bg-red-200 relative">
      <div id="accGreen" class="h-full bg-green-500" style="width:0%"></div>
      <div id="accLabel" class="absolute inset-0 flex items-center justify-center font-semibold text-white drop-shadow">0%</div>
    </div>

    <div class="mt-3 text-slate-700">
      <span id="accCounts">0 correct out of 0 viewed</span>
    </div>

    <!-- per-subject accuracy -->
    <div class="mt-6">
      <h3 class="font-semibold text-slate-900 mb-2">Accuracy by subject</h3>
      <div id="accBreakdown" class="space-y-3"></div>
    </div>
  </div>

  <!-- Avg viewing time card -->
  <div class="bg-white rounded-2xl p-6 shadow border border-gray-200">
    <h2 class="text-xl font-semibold mb-1 text-slate-900">Average time per problem</h2>
    <p class="text-slate-600 mb-4">Average of total time spent viewing each question.</p>
    <div class="text-5xl leading-none font-extrabold text-slate-900">
      <span id="avgSec">0.00</span><span class="text-xl font-semibold text-slate-500"> s</span>
    </div>

    <!-- per-subject avg time -->
    <div class="mt-6">
      <h3 class="font-semibold text-slate-900 mb-2">Avg time by subject</h3>
      <div id="timeBreakdown" class="space-y-2"></div>
    </div>
  </div>
</div>

<div class="mt-8">
  <a href="/dashboard/"
     class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition">
    Back to Dashboard
  </a>
</div>
{% endblock %}

{% block scripts %}
<script>
async function fetchJSON(url){
  const r = await fetch(url, { headers:{'Accept':'application/json'} });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// Defensive helper: accept seconds if provided; if ms slipped through, convert.
function toSecondsMaybe(x){
  if (x == null) return 0;
  const n = Number(x) || 0;
  // If value looks like milliseconds (very large average), convert.
  //  If someone truly averages >120s/question, this still shows correctly
  //  because we only convert when server also sends avg_view_ms (not used here).
  return n > 120 ? (n / 1000) : n;
}

function pctStr(p){ return `${Math.max(0, Math.min(100, Math.round(p||0)))}%`; }

function renderBreakdownBars(containerId, items, mode){
  // mode: 'acc' or 'time'
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = '';
  if (!items || !items.length){
    wrap.innerHTML = '<div class="text-slate-500 text-sm">No data yet.</div>';
    return;
  }
  items.forEach(item => {
    const pct = Math.max(0, Math.min(100, Math.round(item.accuracy_pct || 0)));
    const avgS = toSecondsMaybe(item.avg_view_s || 0).toFixed(2);

    const row = document.createElement('div');
    row.className = 'p-3 rounded-lg border border-gray-200 bg-white/70';

    // top line: label + tiny counts
    const top = document.createElement('div');
    top.className = 'flex items-center justify-between mb-2';
    top.innerHTML = `
      <div class="font-medium text-slate-900">${item.label}</div>
      <div class="text-sm text-slate-500">${item.correct_viewed_count || 0} / ${item.viewed_count || 0} correct</div>
    `;
    row.appendChild(top);

    // bar
    const bar = document.createElement('div');
    bar.className = 'w-full h-3 rounded-md overflow-hidden bg-red-200 relative';
    bar.innerHTML = `
      <div class="h-full bg-green-500" style="width:${pct}%"></div>
      <div class="absolute inset-0 flex items-center justify-center text-[11px] font-semibold text-white">${pct}%</div>
    `;
    row.appendChild(bar);

    // extra line for time mode
    if (mode === 'time'){
      const btm = document.createElement('div');
      btm.className = 'mt-2 text-sm text-slate-600';
      btm.innerHTML = `Avg time: <span class="font-semibold text-slate-900">${avgS}</span> s`;
      row.appendChild(btm);
    }

    wrap.appendChild(row);
  });
}

function renderStats(s){
  // Overall accuracy
  const pct = Math.max(0, Math.min(100, Math.round(s.accuracy_pct || 0)));
  document.getElementById('accGreen').style.width = pct + '%';
  document.getElementById('accLabel').textContent = `${pct}%`;
  document.getElementById('accCounts').textContent =
    `${s.correct_viewed_count || 0} correct out of ${s.viewed_count || 0} viewed`;

  // Overall average time (seconds, but guard if ms slipped in)
  const secs = toSecondsMaybe(s.avg_view_s).toFixed(2);
  document.getElementById('avgSec').textContent = secs;

  // Per-subject panels
  renderBreakdownBars('accBreakdown', s.breakdown || [], 'acc');
  renderBreakdownBars('timeBreakdown', s.breakdown || [], 'time');
}

(async function init(){
  try{
    const data = await fetchJSON('/api/stats/me/');
    renderStats(data);
  }catch(e){
    console.error(e);
  }
})();
</script>
{% endblock %}



