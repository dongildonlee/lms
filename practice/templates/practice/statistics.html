{% extends "base.html" %}
{% block title %}Statistics | Wrong-Answer Packets{% endblock %}

{% block content %}
<h1 class="text-3xl font-semibold mb-6 text-white drop-shadow">Your Statistics</h1>

<div class="grid gap-6 md:grid-cols-2">
  <!-- Accuracy card -->
  <div class="bg-white rounded-2xl p-6 shadow border border-gray-200">
    <h2 class="text-xl font-semibold mb-1 text-slate-900">Accuracy</h2>
    <p class="text-slate-600 mb-4">(# correct of all questions you viewed)</p>

    <div id="accBarWrapper" class="w-full h-8 rounded-lg overflow-hidden bg-red-200 relative">
      <div id="accGreen" class="h-full bg-green-500" style="width:0%"></div>
      <div id="accLabel" class="absolute inset-0 flex items-center justify-center font-semibold text-white drop-shadow"></div>
    </div>

    <div class="mt-3 text-slate-700">
      <span id="accCounts"></span>
    </div>
  </div>

  <!-- Avg viewing time card -->
  <div class="bg-white rounded-2xl p-6 shadow border border-gray-200">
    <h2 class="text-xl font-semibold mb-1 text-slate-900">Average time per problem</h2>
    <p class="text-slate-600 mb-4">Average of total time spent viewing each question.</p>
    <div class="text-4xl font-bold text-slate-900">
      <span id="avgSec">â€“</span><span class="text-xl font-semibold text-slate-500"> s</span>
    </div>
  </div>
</div>

<!-- Breakdown -->
<div class="mt-10 bg-white rounded-2xl p-6 shadow border border-gray-200">
  <h2 class="text-xl font-semibold text-slate-900 mb-4">By subject</h2>
  <div id="breakdownList" class="space-y-4"></div>
</div>

<div class="mt-8">
  <a href="/dashboard/"
     class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition">
    Back to Dashboard
  </a>
</div>
{% endblock %}

{% block scripts %}
<script>
async function fetchJSON(url){
  const r = await fetch(url, { headers:{'Accept':'application/json'} });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

function renderOverall(s){
  const pct = Math.max(0, Math.min(100, Number(s.accuracy_pct || 0)));
  const green = document.getElementById('accGreen');
  const label = document.getElementById('accLabel');
  green.style.width = pct + '%';
  label.textContent = `${pct}%`;

  document.getElementById('accCounts').textContent =
    `${s.correct_viewed_count} correct out of ${s.viewed_count} viewed`;

  // avg seconds is already seconds from API
  const avg = Number(s.avg_view_s || 0);
  document.getElementById('avgSec').textContent = avg.toFixed(2);
}

function miniBar(pct){
  pct = Math.max(0, Math.min(100, Number(pct || 0)));
  return `
    <div class="w-full h-4 rounded bg-red-200 overflow-hidden relative">
      <div class="h-full bg-green-500" style="width:${pct}%"></div>
      <div class="absolute inset-0 text-xs font-semibold text-white flex items-center justify-center">${pct}%</div>
    </div>
  `;
}

function renderBreakdown(rows){
  const wrap = document.getElementById('breakdownList');
  if (!rows || !rows.length){
    wrap.innerHTML = '<div class="text-slate-600">No data yet.</div>';
    return;
  }

  wrap.innerHTML = rows.map(r => `
    <div class="border border-gray-200 rounded-xl p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold text-slate-900">${r.name}</div>
        <div class="text-sm text-slate-600">
          ${r.correct_viewed_count} / ${r.viewed_count} correct
        </div>
      </div>
      ${miniBar(r.accuracy_pct)}
      <div class="mt-2 text-sm text-slate-700">
        Avg time: <span class="font-semibold">${Number(r.avg_view_s || 0).toFixed(2)}</span> s
      </div>
    </div>
  `).join('');
}

(async function init(){
  try{
    const data = await fetchJSON('/api/stats/me/');
    renderOverall(data);
    renderBreakdown(data.breakdown || []);
  }catch(e){
    console.error(e);
  }
})();
</script>
{% endblock %}


