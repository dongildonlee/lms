{% extends "base.html" %}
{% block title %}Practice | Wrong-Answer Packets{% endblock %}

{% block content %}
<h1 class="text-3xl font-semibold mb-6 text-white drop-shadow">
  Practice <span id="subjectLabel" class="text-gray-300 text-lg"></span>
</h1>

<style>
  /* readable/clean TeX & cards */
  #qCard mjx-container { line-height: 1.6; }
  #qCard mjx-container[display="true"] { display:block; margin:.5rem 0; }
  #qCard mjx-container:not([display="true"]) { display:inline; }
  #qCard, #qCard * { color: #0f172a; }
  .latex-pdf { width:100%; height:420px; border:0; display:block; }
  .latex-pdf.choice { height:96px; }
</style>

<div id="qCard" class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 hidden">
  <div id="stem" class="text-lg mb-4 whitespace-normal leading-7"></div>
  <div id="choices" class="space-y-2"></div>
  <div id="feedback" class="mt-4 font-semibold"></div>

  <div class="mt-6 flex items-center gap-3">
    <button id="nextBtn"
      class="inline-flex items-center justify-center px-4 py-2 rounded-xl
             border border-gray-200 bg-white/90 text-ink
             transition duration-200 ease-out transform
             hover:-translate-y-0.5 hover:shadow-md hover:bg-white
             focus:outline-none focus:ring-2 focus:ring-blue-500/30
             motion-reduce:transform-none motion-reduce:transition-none">
      Next ▶
    </button>

    <a href="/dashboard/"
       class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition">
      Back to Dashboard
    </a>
  </div>
</div>

<div id="status" class="mt-4 text-white/80"></div>
{% endblock %}

{% block scripts %}
<script>
const $ = (s) => document.querySelector(s);
let attemptId = null, currentQ = null;

/* read ?tag=… from the dashboard link */
function qp(name){
  const m = new RegExp('[?&]'+name+'=([^&]*)').exec(location.search);
  return m ? decodeURIComponent(m[1].replace(/\+/g,' ')) : '';
}

/* Only for lightweight MathJax content */
function normalizeTex(s){
  if(!s) return '';
  return s.replace(/<br\s*\/?>/gi,' ')
          .replace(/\\\\(?!\[|\(|\{)/g,' ')
          .replace(/\s*\n+\s*/g,' ')
          .replace(/\s{2,}/g,' ')
          .trim();
}

/* Decide when we need the real LaTeX engine */
function needsFullLaTeX(s){
  if(!s) return false;
  return /\\begin\{(tabular|array|align\*?|tcolorbox|tikzpicture|axis)\}|\\includegraphics|\\documentclass/.test(s);
}

function getCookie(name){
  const v = `; ${document.cookie}`.split(`; ${name}=`);
  return v.length === 2 ? v.pop().split(';').shift() : undefined;
}
const csrftoken = getCookie('csrftoken');

async function api(url, opts={}){
  const o = Object.assign({ headers:{} }, opts);
  if(!o.headers['Content-Type'] && o.body) o.headers['Content-Type'] = 'application/json';
  if(opts.method === 'POST') o.headers['X-CSRFToken'] = csrftoken || '';
  const res = await fetch(url, o);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

/* GET -> application/pdf -> blob URL (works with X-Frame-Options) */
async function fetchPdfBlobUrl(tex){
  const url = '/practice/tex/pdf/?tex=' + encodeURIComponent(tex);
  const res = await fetch(url, { method: 'GET' });
  if(!res.ok){
    const msg = await res.text();
    throw new Error('TeX PDF failed: ' + msg);
  }
  const blob = await res.blob();
  return URL.createObjectURL(blob);
}

async function typeset(){
  const card = $('#qCard');
  if(window.MathJax?.typesetPromise && card) await MathJax.typesetPromise([card]);
}

async function startPractice(){
  const tag = qp('tag') || '';   // auto from URL
  if(tag) $('#subjectLabel').textContent = '— ' + tag;

  try{
    const data = await api('/api/attempts/', { method:'POST', body: JSON.stringify({ assignment_title:'Practice' }) });
    attemptId = data.attempt_id;
    await loadQuestion(tag);
  }catch(err){
    $('#status').textContent = `Failed to start: ${err.message}`;
  }
}

async function loadQuestion(tag){
  $('#qCard').classList.remove('hidden');
  try{
    const qRes = await api(`/api/questions/?limit=1${tag ? `&tag=${encodeURIComponent(tag)}` : ''}`);
    if(!qRes.count){
      $('#stem').innerHTML = `No questions found${tag ? ` for <strong>${tag}</strong>` : ''}.`;
      $('#choices').innerHTML = ''; $('#feedback').textContent=''; $('#status').textContent='';
      await typeset(); return;
    }

    currentQ = qRes.questions[0];

    // --- STEM ---
    const rawStem = currentQ.stem_md || '';
    if(needsFullLaTeX(rawStem)){
      const url = await fetchPdfBlobUrl(rawStem);
      $('#stem').innerHTML = `<object class="latex-pdf" data="${url}" type="application/pdf"></object>`;
    }else{
      $('#stem').innerHTML = normalizeTex(rawStem);
    }

    // --- CHOICES ---
    const choicesDiv = $('#choices'); choicesDiv.innerHTML = '';
    const choices = currentQ.choices || {};
    for(const [key,label] of Object.entries(choices)){
      const raw = label || '';
      const btn = document.createElement('button');
      btn.className = `
        w-full text-left rounded-xl px-4 py-3
        border border-gray-200 bg-white/90 text-ink/90
        transition duration-200 ease-out transform
        hover:-translate-y-0.5 hover:shadow-md hover:bg-white
        focus:outline-none focus:ring-2 focus:ring-blue-500/30
        active:translate-y-0
        motion-reduce:transform-none motion-reduce:transition-none
      `.replace(/\s+/g,' ').trim();

      if(needsFullLaTeX(raw)){
        const url = await fetchPdfBlobUrl(raw);
        btn.innerHTML = `<span class="font-semibold mr-2">${key})</span>
                         <object class="latex-pdf choice" data="${url}" type="application/pdf"></object>`;
      }else{
        btn.innerHTML = `<span class="font-semibold mr-2">${key})</span> ${normalizeTex(raw)}`;
      }
      btn.onclick = () => submitAnswer(key);
      choicesDiv.appendChild(btn);
    }

    $('#feedback').textContent = ''; $('#status').textContent = '';
    await typeset();
  }catch(err){
    console.error(err);
    $('#status').textContent = `Failed to load question: ${err.message}`;
    $('#stem').innerHTML = ''; $('#choices').innerHTML = ''; $('#feedback').textContent = '';
  }
}

async function submitAnswer(choiceKey){
  if(!attemptId || !currentQ) return;
  try{
    const res = await api(`/api/attempts/${attemptId}/items/`, {
      method:'POST',
      body: JSON.stringify({ question_id: currentQ.id, answer:{ choice: choiceKey } })
    });
    const ok = !!res.is_correct;
    $('#feedback').textContent = ok ? '✅ Correct' : '❌ Incorrect';
    $('#feedback').className = ok ? 'mt-4 font-semibold text-green-600' : 'mt-4 font-semibold text-red-600';
  }catch(err){
    $('#feedback').textContent = `Submit failed: ${err.message}`;
    $('#feedback').className = 'mt-4 font-semibold text-red-600';
  }
}

$('#nextBtn').addEventListener('click', () => loadQuestion(qp('tag')));
document.addEventListener('DOMContentLoaded', startPractice);
</script>

<!-- MathJax (kept at the bottom so it’s loaded when typeset() runs) -->
<script>
  window.MathJax = { tex:{ inlineMath:[['$','$'],['\\(','\\)']] }, svg:{ fontCache:'global' } };
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
{% endblock %}




